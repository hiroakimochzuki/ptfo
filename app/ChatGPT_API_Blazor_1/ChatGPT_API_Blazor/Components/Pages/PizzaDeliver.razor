@page "/pizzadeliver"
@using ChatGPT_API_Blazor.Model
@inject CartService CartService
@rendermode InteractiveServer



<h3>Available Pizzas</h3>

<div class="pizza-grid">
    @foreach (var special in specials)
    {
        <div class="pizza-card">
            <img src="@special.ImageUrl" alt="@special.Name" />
            <h4>@special.Name</h4>
            <p>@special.Description</p>
            <strong>$@special.BasePrice</strong>

            <button @onclick="() => AddPizzaToCart(special)">カートに追加</button> @* ←これが必要！ *@
        </div>
    }
</div>

<div class="cart-details">
    <h4>カートの中身: @itemCount 件</h4>
    <ul>
        @foreach (var item in cartItems)
        {
            <li>
                @item.Pizza.Name x @item.Quantity - $@(item.Pizza.BasePrice * item.Quantity)
                <button @onclick="() => DecreaseQuantity(item.Pizza.Id)">−</button>
                <button @onclick="() => IncreaseQuantity(item.Pizza.Id)">＋</button>
            </li>
        }
    </ul>
</div>


<div class="cart-summary">

    <NavLink class="btn-order" href="/pizzaorder">注文画面へ進む</NavLink>
</div>


<style>
    .pizza-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
    }

    .pizza-card {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    text-align: center;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .pizza-card img {
    max-width: 100%;
    border-radius: 8px;
    height: 150px;
    object-fit: cover;
    }

    .pizza-card h4 {
    margin: 10px 0 5px;
    }

    .pizza-card p {
    font-size: 0.9rem;
    color: #555;
    }

    .pizza-card strong {
    display: block;
    margin-top: 10px;
    font-size: 1.1rem;
    color: #d32f2f;
    }

    .pizza-card button {
    margin-top: 10px;
    padding: 6px 12px;
    background-color: #1976d2;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    }

    .cart-details {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background-color: #f9f9f9;
    }

        .cart-details ul {
            list-style: none;
            padding-left: 0;
        }

        .cart-details li {
            margin: 4px 0;
        }

        .cart-details button {
            margin-left: 5px;
            padding: 2px 6px;
            font-size: 1rem;
        }


    .cart-summary {
    margin-top: 30px;
    text-align: center;
    }

    .btn-order {
    margin-top: 10px;
    padding: 10px 20px;
    background-color: #43a047;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    display: inline-block;
    }

</style>


@code {
    List<PizzaSpecial> specials = new();
    int itemCount;
    string lastMessage = "";

    List<CartItem> cartItems = new();
    protected override void OnInitialized()
    {
        specials = new()
        {
            new PizzaSpecial { Id = 1, Name = "The Baconatorizor", BasePrice =  11.99M, Description = "It has EVERY kind of bacon", ImageUrl="img/pizzas/bacon.jpg"},
            new PizzaSpecial { Id = 2, Name = "Buffalo chicken", BasePrice =  12.75M, Description = "Spicy chicken, hot sauce, and blue cheese", ImageUrl="img/pizzas/meaty.jpg"},
            new PizzaSpecial { Id = 3, Name = "Veggie Delight", BasePrice =  11.5M, Description = "It's like salad, but on a pizza", ImageUrl="img/pizzas/salad.jpg"},
            new PizzaSpecial { Id = 4, Name = "Margherita", BasePrice =  9.99M, Description = "Traditional Italian pizza with tomatoes and basil", ImageUrl="img/pizzas/margherita.jpg"},
            new PizzaSpecial { Id = 5, Name = "Basic Cheese Pizza", BasePrice =  11.99M, Description = "It's cheesy and delicious", ImageUrl="img/pizzas/cheese.jpg"},
            new PizzaSpecial { Id = 6, Name = "Classic pepperoni", BasePrice =  10.5M, Description = "It's the pizza you grew up with", ImageUrl="img/pizzas/pepperoni.jpg" }
        };

        itemCount = CartService.GetItemCount();
        cartItems = CartService.GetCartItems();
    }

    void AddPizzaToCart(PizzaSpecial special)
    {
        lastMessage = $"カートに {special.Name} を追加しました";
        CartService.AddToCart(special);
        itemCount = CartService.GetItemCount();
        cartItems = CartService.GetCartItems();
        StateHasChanged();
    }

    void IncreaseQuantity(int pizzaId)
    {
        var item = cartItems.FirstOrDefault(i => i.Pizza.Id == pizzaId);
        if (item != null)
        {
            CartService.UpdateQuantity(pizzaId, item.Quantity + 1);
            RefreshCart();
        }
    }

    void DecreaseQuantity(int pizzaId)
    {
        var item = cartItems.FirstOrDefault(i => i.Pizza.Id == pizzaId);
        if (item != null)
        {
            int newQty = item.Quantity - 1;
            CartService.UpdateQuantity(pizzaId, newQty);
            RefreshCart();
        }
    }

    void RefreshCart()
    {
        itemCount = CartService.GetItemCount();
        cartItems = CartService.GetCartItems();
        StateHasChanged();
    }

    

}




